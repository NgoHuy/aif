#!/bin/bash
depend_procedure core base # esp for auto_{network,locale,fstab}, intro and set_clock workers


# This is a port of the original /arch/setup script.  It doesn't use aif phases but uses it's own menu-based flow (phase) control

BLOCK_ROLLBACK_USELESS=1

# clock
HARDWARECLOCK=
TIMEZONE=

# default filesystem specs (the + is bootable flag)
# <mountpoint>:<partsize>:<fstype>[:+]
DEFAULTFS="/boot:32:ext2:+ swap:256:swap /:7500:ext3 /home:*:ext3"

declare -A workertitles
workertitles['select_source']='Select source'
workertitles['set_editor']='Set editor'
workertitles['runtime_network']='Setup network'
workertitles['select_mirror']='Select mirror'
workertitles['set_clock']='Set clock'
workertitles['prepare_disks']='Prepare hard drive(s)'
workertitles['package_list']='Select packages'
workertitles['install_packages']='Install packages'
workertitles['configure_system']='Configure system'
workertitles['install_bootloader']='Install bootloader'

start_process ()
{
	#####################
	## begin execution ##

	execute worker configure
	execute worker intro
	execute worker sysprep

	# menu item tracker- autoselect the next item
	NEXTITEM="1"
	
	while true
	do
    		mainmenu
	done
}


mainmenu()  
{
	default=no
	[ -n "$NEXTITEM" ] && default="$NEXTITEM"
	menu_workers=(select_source set_editor set_clock prepare_disks package_list install_packages configure_system install_bootloader)
	menu=()
	for i in ${!menu_workers[@]}
	do
		let i+=1 # we count from 1 onwards, not from 0
		worker=${menu_workers[$i]}
		title=${workertitles[$worker]}
		menu+=($i "$title")
	done
	let i+=1
	menu+=($i "Exit Install")

	ask_option $default "MAIN MENU" '' required "${menu[@]}"
	case $ANSWER_OPTION in
	"1")
		                                        execute worker select_source; local ret=$?; [ $ret -eq 0 -a "$var_PKG_SOURCE_TYPE" = net ] && execute worker select_source_extras_menu
		                                                                                    [ $ret -eq 0 ] && execute worker runtime_packages             && NEXTITEM=2 ;;

	"2")
                                                        execute worker set_editor                                                                                 && NEXTITEM=3 ;;
        "3")
		                                        execute worker set_clock                                                                                  && NEXTITEM=4 ;;
        "4")
		                                        execute worker prepare_disks                                                                              && NEXTITEM=5 ;;
        "5")
		check_depend worker prepare_disks && \
		check_depend worker select_source    && execute worker package_list                                                                               && NEXTITEM=6 ;;
        "6")
		check_depend worker package_list && \
		check_depend worker select_source    && execute worker install_packages   && {                                    execute worker auto_locale  ; \
		                                                                                                                  execute worker auto_keymap_font;
		                                                                                                                  true                        ; } && NEXTITEM=7 ;;
        "7")
		check_depend worker install_packages && execute worker configure_system   && {                                    execute worker mkinitcpio   ; \
		                                                                                                                  execute worker locales      ;
		                                                                                                                  execute worker initialtime  ;
		                                                                                                                  true                        ; } && NEXTITEM=8 ;;
        "8")
		check_depend worker configure_system && execute worker install_bootloader                                                                         && NEXTITEM=9 ;;
        "9")
		notify "If the install finished successfully, you can now type 'reboot' to restart the system." && stop_installer ;;
        *)
		execute worker abort_installer;;
    esac
}


worker_configure_system()
{
	interactive_configure_system
}


worker_prepare_disks()
{
	get_possible_fs
	interactive_prepare_disks
}


worker_select_source ()
{
	#TODO: how to handle user going here again? discard previous settings, warn him that he already done it?
	interactive_select_source && return 0
	return 1
}

worker_set_editor ()
{
	seteditor force
}

worker_intro ()
{
	notify "Welcome to the Arch Linux Installation program. The install\
 process is fairly straightforward, and you should run through the options in\
 the order they are presented. If you are unfamiliar with partitioning/making\
 filesystems, you may want to consult some documentation before continuing.\
 You can view all output from commands by viewing your VC7 console (ALT-F7).\
 ALT-F1 will bring you back here.\n\n$DISCLAIMER"
}


worker_configure ()
{
	var_UI_TYPE=${arg_ui_type:-dia}
	ui_init
}


# select_packages()
# prompts the user to select packages to install
worker_package_list() {
	# if selection has been done before, warn about loss of input and let the user exit gracefully
	ended_ok worker package_list && ! ask_yesno "WARNING: Running this stage again will result in the loss of previous package selections.\n\nDo you wish to continue?" && return 0

	interactive_select_packages
}


worker_install_packages ()
{
	installpkg && return 0
	return 1
}


# Hand-hold through setting up networking
worker_runtime_network() {
	interactive_runtime_network
}


worker_select_mirror ()
{
	interactive_select_mirror
}


worker_install_bootloader ()
{
	interactive_install_bootloader
}


worker_auto_network ()
{
	# if the user has been through networking setup, it may be useful to export the users' choices to the target system
	# networking setup could have happened in a separate process (eg partial-configure-network), so check if the settings file was created to be sure
	if [ -f $RUNTIME_DIR/aif-network-settings ]
	then
		ask_yesno "Do you want to use the network settings from the installer in rc.conf and resolv.conf?\n\nIf you used Proxy settings, they will be written to /etc/profile.d/proxy.sh" || return 0
		if ! target_configure_network
		then
			show_warning "Automatic network settings propagation failed" "Failed to import current network settings into target system"
			return 1
		fi
	fi
	return 0
}

worker_abort_installer ()
{
	ret=0
	ask_yesno "Abort Installation?" || return
	maybe_interactive_rollback_filesystems || ret=$?
	stop_installer || ret=$?
	return $ret
}
